(ns dev.backtest.backtest-trailing
  (:require
   [tick.core :as t]
   [tablecloth.api :as tc]
   [quanta.trade.backtest2 :refer [entry->roundtrips backtest]]))

(def bar-ds
  (tc/dataset {:date [(t/instant "2024-09-01T00:00:00Z")
                      (t/instant "2024-09-02T00:00:00Z")
                      (t/instant "2024-09-03T00:00:00Z")
                      (t/instant "2024-09-04T00:00:00Z")
                      (t/instant "2024-09-05T00:00:00Z")
                      (t/instant "2024-09-06T00:00:00Z")
                      (t/instant "2024-09-07T00:00:00Z")
                      (t/instant "2024-09-08T00:00:00Z")
                      (t/instant "2024-09-09T00:00:00Z")
                      (t/instant "2024-09-10T00:00:00Z")
                      (t/instant "2024-09-11T00:00:00Z")
                      (t/instant "2024-09-12T00:00:00Z")]

               :open [100.0 110.0 120.0 120.0
                      130.0 140.0 150.0
                      146.0 146.0 141.0 141.0 141.0]
               :high [100.0 110.0 120.0 120.0
                      130.0 140.0 150.0
                      146.0 146.0 141.0 141.0 141.0]
               :low [100.0 110.0 120.0 120.0
                     130.0 140.0 150.0
                     146.0 146.0 141.0 141.0 141.0]
               :close [100.0 110.0 120.0 120.0
                       130.0 140.0 150.0
                       146.0 146.0 141.0 141.0 141.0]
               :atr [5.0 5.0 5.0 5.0
                     5.0 5.0 5.0
                     5.0 5.0 5.0 5.0 5.0]
               :entry [:long :long nil nil
                       :flat :flat :flat
                       :flat nil nil nil]}))

bar-ds

(def opts
  {:asset "EUR/USD"
   :portfolio {:fee 0.05
               :equity-initial 10000.0}
   :entry {:type :fixed-qty :fixed-qty 1.0}
   :exit [{:type :trailing-stop-offset :col :atr}]})

(-> (entry->roundtrips opts bar-ds)
    :level-ds)
;; => _unnamed [12 9]:
;;    
;;    |                :date | :open | :high |  :low | :close | :atr | :entry | :target-profit | :target-loss |
;;    |----------------------|------:|------:|------:|-------:|-----:|--------|----------------|-------------:|
;;    | 2024-09-01T00:00:00Z | 100.0 | 100.0 | 100.0 |  100.0 |  5.0 |  :long |                |        145.0 |
;;    | 2024-09-02T00:00:00Z | 110.0 | 110.0 | 110.0 |  110.0 |  5.0 |  :long |                |        145.0 |
;;    | 2024-09-03T00:00:00Z | 120.0 | 120.0 | 120.0 |  120.0 |  5.0 |        |                |        145.0 |
;;    | 2024-09-04T00:00:00Z | 120.0 | 120.0 | 120.0 |  120.0 |  5.0 |        |                |        145.0 |
;;    | 2024-09-05T00:00:00Z | 130.0 | 130.0 | 130.0 |  130.0 |  5.0 |  :flat |                |        145.0 |
;;    | 2024-09-06T00:00:00Z | 140.0 | 140.0 | 140.0 |  140.0 |  5.0 |  :flat |                |        145.0 |
;;    | 2024-09-07T00:00:00Z | 150.0 | 150.0 | 150.0 |  150.0 |  5.0 |  :flat |                |        145.0 |
;;    | 2024-09-08T00:00:00Z | 146.0 | 146.0 | 146.0 |  146.0 |  5.0 |  :flat |                |        145.0 |
;;    | 2024-09-09T00:00:00Z | 146.0 | 146.0 | 146.0 |  146.0 |  5.0 |        |                |        145.0 |
;;    | 2024-09-10T00:00:00Z | 141.0 | 141.0 | 141.0 |  141.0 |  5.0 |        |                |              |
;;    | 2024-09-11T00:00:00Z | 141.0 | 141.0 | 141.0 |  141.0 |  5.0 |        |                |              |
;;    | 2024-09-12T00:00:00Z | 141.0 | 141.0 | 141.0 |  141.0 |  5.0 |        |                |              |

(-> (backtest opts bar-ds)
    :roundtrip-ds)
;; => _unnamed [1 29]:
;;    
;;    | :entry-idx |          :entry-date | :entry-price | :exit-idx |    :id | :side | :qty | :exit-price |   :exit-reason |  :asset |           :exit-date | :fee | :volume-trading |   :cum-log | :volume-exit | :equity | :bars | :win? | :volume-entry | :cum-prct |    :pl-log |  :pl | :pl-gross | :pl-prct | :equity-max | :pl-points | :cum-points | :drawdown | :drawdown-prct |
;;    |-----------:|----------------------|-------------:|----------:|--------|-------|-----:|------------:|----------------|---------|----------------------|-----:|----------------:|-----------:|-------------:|--------:|------:|-------|--------------:|----------:|-----------:|-----:|----------:|---------:|------------:|-----------:|------------:|----------:|---------------:|
;;    |          0 | 2024-09-01T00:00:00Z |        100.0 |         9 | XvvnF7 | :long |  1.0 |       141.0 | :trailing-stop | EUR/USD | 2024-09-10T00:00:00Z |  0.1 |           241.0 | 0.14921911 |        141.0 | 10040.9 |     9 |  true |         100.0 |      40.9 | 0.14921911 | 40.9 |      41.0 |     40.9 |     10040.9 |       41.0 |        41.0 |       0.0 |            0.0 |


